<!DOCTYPE html>
<html>
<head>	
	<title>TTA Dot Density Lasso Tool</title>

	<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha512-gc3xjCmIy673V6MyOAZhIW93xhM9ei1I+gLbmFjUHIjocENRsLX/QUE1htk5q1XV2D/iie/VQ8DXI6Vu8bexvQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha512-ozq8xQKq6urvuU6jNgkfqAmT7jKN2XumbrX1JiB3TnF7tI48DPI4Gy1GXKD/V3EExgAs1V+pRO7vwtS1LHg0Gw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://unpkg.com/togeojson@0.16.0"></script>
    <script src="https://unpkg.com/leaflet-filelayer@1.2.0"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>

    <style>
    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        margin: 0;
        font-family: "Open Sans", "Roboto", "Lato", "Helvetica Neue", Arial, sans-serif;
    }
    #map {
        width: 100%; 
        height: 100%; 
        display: block;
    }
    .icon {
        max-width: 70%;
        max-height: 70%;
        margin: 4px;
    }
    .info-panel {
        z-index: 1001;
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: white;
        border: 1px solid #333;
        padding: 10px;
    }
    .info-panel h4 {
        margin: 0px 0px 2px 0px; 
    }
    .info-panel p {
        margin: 0px 0px 0px 0px; 
    }


    </style>


</head>
<body>

<div id="map"></div>
<div class="info-panel">
    <h4>Number of dots</h4>
    <p><span id="loaded"></span></p>
    <p><span id="within"></span></p>
    <p><span id="percent-within"></span></p>

</div>
<script>

    window.onload = function() {

        const map = L.map('map').setView([39.8, -98.5], 5);
        let ptsWithin;
        let pctWithin;
        let loadedEle = document.getElementById("loaded");
        let withinEle = document.getElementById("within");
        let pctWithinEle = document.getElementById("percent-within");


        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {
            attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20,
            minZoom: 0
        }).addTo(map);

        // FeatureGroup is to store editable layers
        let drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        let placerDotDensity;

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                marker: false,
                circle: false,
                circlemarker: false,
                rectangle: false,
                polyline: false
            },
            edit: {
                featureGroup: drawnItems,
                edit: true
            }
        });
        map.addControl(drawControl);

        // draw tool listeners
        map.on('draw:created', function (e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
            const placerDotDensityGeoJSON = placerDotDensity.toGeoJSON();
            const drawnItemsGeoJSON = drawnItems.toGeoJSON();

            ptsWithin = turf.pointsWithinPolygon(placerDotDensityGeoJSON, drawnItemsGeoJSON);

            pctWithin = (ptsWithin.features.length / placerDotDensity.getLayers().length) * 100;
            pctWithin =  pctWithin.toFixed(1);

            withinEle.innerHTML = "Within: " + ptsWithin.features.length;
            pctWithinEle.innerHTML = "Percent Within: " + pctWithin + "%";

        });

        map.on('draw:edited', function (e) {
            const placerDotDensityGeoJSON = placerDotDensity.toGeoJSON();
            const drawnItemsGeoJSON = drawnItems.toGeoJSON();

            ptsWithin = turf.pointsWithinPolygon(placerDotDensityGeoJSON, drawnItemsGeoJSON);

            pctWithin = (ptsWithin.features.length / placerDotDensity.getLayers().length) * 100;
            pctWithin =  pctWithin.toFixed(1);

            withinEle.innerHTML = "Within: " + ptsWithin.features.length;
            pctWithinEle.innerHTML = "Percent Within: " + pctWithin + "%";

        });

        map.on('draw:deleted', function (e) {
            withinEle.innerHTML = "";
            pctWithinEle.innerHTML = "";
        });

        

        // Import KMLs
        const style = {
            color: 'rgb(94, 99, 229)',
            opacity: 0.7,
            fillOpacity: 0.7,
            weight: 0.5,
            clickable: false,
            radius: 2
        };
        L.Control.FileLayerLoad.LABEL = '<img class="icon" src="https://makinacorpus.github.io/Leaflet.FileLayer/folder.svg" alt="file icon"/>';
        control = L.Control.fileLayerLoad({
            fileSizeLimit: 20480,
            fitBounds: true,
            formats: [
                '.kml'
            ],
            layerOptions: {
                style: style,
                pointToLayer: function (data, latlng) {
                    return L.circleMarker(
                        latlng,
                        { style: style }
                    );
                }
            }
        });
        control.addTo(map);
        control.loader.on('data:loaded', function (e) {
            placerDotDensity = e.layer;
            loadedEle.innerHTML = "Loaded: " + placerDotDensity.getLayers().length;
        });

    }

</script>



</body>
</html>
